/**
 * New node file
 */
module.exports = function(){
	return function(req,res,next){
		res.locals.backUrl = 'http://' + req.headers.host + req.url;
		
		res.locals.user = null;
		res.locals.login = function(){}
		if(req.app.locals.authorize){
			var auth = req.app.locals.authorize;
			res.authorize = auth;
			res.locals.login = login.bind(res);
			if(auth.anyUser){ //需要登陆
				if(auth.ticketName){//定义了cookies的键
					var ticket = req.cookies[auth.ticketName];
					if(!ticket){
						if(auth.needLogin)
							req.app.emit('NotLogin',req,res,1);
					}else{
						var aes = require('./aes');
						res.locals.user = JSON.parse(aes().decode(decodeURIComponent(ticket)));
					}
				}else{
					if(auth.needLogin)
						req.app.emit('NotLogin',req,res,2);
				}
			}
		}
		next();
	}
}



var login = function(goLogin){
	if(!this.locals.user){
		if(goLogin){
			this.redirect(this.authorize.loginUrl+'?backurl=' + encodeURIComponent(this.locals.backUrl));
		}
		return false;
	}else{
		return this.locals.user;
	}
}